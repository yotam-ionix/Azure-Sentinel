{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.13.1.58284",
      "templateHash": "6267106311640858417"
    }
  },
  "parameters": {
    "DataCollectionEndpointName": {
      "type": "string",
      "defaultValue": "[format('dce-mdvm-{0}', uniqueString(resourceGroup().id))]",
      "metadata": {
        "description": "Name for Data Collection Endpoint used to ingest data into Log Analytics workspace."
      }
    },
    "DataCollectionRuleName": {
      "type": "string",
      "defaultValue": "[format('dcr-mdmv-{0}', uniqueString(resourceGroup().id))]",
      "metadata": {
        "description": "Name for Data Collection Rule used to ingest data into Log Analytics workspace."
      }
    },
    "LogAnalyticsWorkspaceResourceId": {
      "type": "string",
      "metadata": {
        "description": "Azure Resource Id of the Log Analytics Workspace where you like the MDVM and optional Function App Application Insights data to reside. The format is: \"/subscriptions/xxxxxxxx-xxxxxxxx-xxxxxxxx-xxxxxxxx-xxxxxxxx/resourcegroups/xxxxxxxx/providers/microsoft.operationalinsights/workspaces/xxxxxxxx\""
      }
    },
    "LogAnalyticsWorkspaceLocation": {
      "type": "string",
      "allowedValues": [
        "asia",
        "asiapacific",
        "australia",
        "australiacentral",
        "australiacentral2",
        "australiaeast",
        "australiasoutheast",
        "brazil",
        "brazilsouth",
        "brazilsoutheast",
        "canada",
        "canadacentral",
        "canadaeast",
        "centralindia",
        "centralus",
        "centraluseuap",
        "eastasia",
        "eastus",
        "eastus2",
        "eastus2euap",
        "europe",
        "france",
        "francecentral",
        "francesouth",
        "germany",
        "germanynorth",
        "germanywestcentral",
        "global",
        "india",
        "japan",
        "japaneast",
        "japanwest",
        "korea",
        "koreacentral",
        "koreasouth",
        "northcentralus",
        "northeurope",
        "norway",
        "norwayeast",
        "norwaywest",
        "qatarcentral",
        "southafrica",
        "southafricanorth",
        "southafricawest",
        "southcentralus",
        "southeastasia",
        "southindia",
        "swedencentral",
        "switzerland",
        "switzerlandnorth",
        "switzerlandwest",
        "uaecentral",
        "uaenorth",
        "uksouth",
        "ukwest",
        "unitedstates",
        "westcentralus",
        "westeurope",
        "westindia",
        "westus",
        "westus2",
        "westus3"
      ],
      "metadata": {
        "description": "Azure location/region of the Log Analytics Workspace referenced in the LogAnalyticsWorkspaceResourceId parameter."
      }
    },
    "ServicePrincipalId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional: Managed Identity or Service Principal ID to be assigned the Metrics Publisher role on the data collection rule."
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.Insights/dataCollectionEndpoints",
      "apiVersion": "2021-09-01-preview",
      "name": "[parameters('DataCollectionEndpointName')]",
      "location": "[parameters('LogAnalyticsWorkspaceLocation')]",
      "properties": {}
    },
    {
      "condition": "[not(equals(parameters('ServicePrincipalId'), ''))]",
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2020-10-01-preview",
      "scope": "[format('Microsoft.Insights/dataCollectionRules/{0}', parameters('DataCollectionRuleName'))]",
      "name": "[guid(resourceId('Microsoft.Insights/dataCollectionRules', parameters('DataCollectionRuleName')), '/providers/Microsoft.Authorization/roleDefinitions/3913510d-42f4-4e42-8a64-420c390055eb')]",
      "properties": {
        "roleDefinitionId": "/providers/Microsoft.Authorization/roleDefinitions/3913510d-42f4-4e42-8a64-420c390055eb",
        "principalId": "[parameters('ServicePrincipalId')]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Insights/dataCollectionRules', parameters('DataCollectionRuleName'))]"
      ]
    },
    {
      "type": "Microsoft.Insights/dataCollectionRules",
      "apiVersion": "2022-06-01",
      "name": "[parameters('DataCollectionRuleName')]",
      "location": "[parameters('LogAnalyticsWorkspaceLocation')]",
      "properties": {
        "dataCollectionEndpointId": "[resourceId('Microsoft.Insights/dataCollectionEndpoints', parameters('DataCollectionEndpointName'))]",
        "streamDeclarations": {
          "Custom-MDVMVulnerabilitiesByDevice_CL": {
            "columns": [
              {
                "name": "cveId",
                "type": "string"
              },
              {
                "name": "cvssScore",
                "type": "real"
              },
              {
                "name": "deviceId",
                "type": "string"
              },
              {
                "name": "deviceName",
                "type": "string"
              },
              {
                "name": "diskPaths",
                "type": "dynamic"
              },
              {
                "name": "endOfSupportDate",
                "type": "dynamic"
              },
              {
                "name": "endOfSupportStatus",
                "type": "dynamic"
              },
              {
                "name": "exploitabilityLevel",
                "type": "string"
              },
              {
                "name": "firstSeenTimestamp",
                "type": "datetime"
              },
              {
                "name": "vulnId",
                "type": "string"
              },
              {
                "name": "lastSeenTimestamp",
                "type": "datetime"
              },
              {
                "name": "osArchitecture",
                "type": "string"
              },
              {
                "name": "osPlatform",
                "type": "string"
              },
              {
                "name": "osVersion",
                "type": "string"
              },
              {
                "name": "rbacGroupId",
                "type": "int"
              },
              {
                "name": "rbacGroupName",
                "type": "string"
              },
              {
                "name": "recommendationReference",
                "type": "string"
              },
              {
                "name": "recommendedSecurityUpdate",
                "type": "dynamic"
              },
              {
                "name": "recommendedSecurityUpdateId",
                "type": "dynamic"
              },
              {
                "name": "recommendedSecurityUpdateUrl",
                "type": "dynamic"
              },
              {
                "name": "registryPaths",
                "type": "dynamic"
              },
              {
                "name": "securityUpdateAvailable",
                "type": "boolean"
              },
              {
                "name": "softwareName",
                "type": "string"
              },
              {
                "name": "softwareVendor",
                "type": "string"
              },
              {
                "name": "softwareVersion",
                "type": "string"
              },
              {
                "name": "TimeGenerated",
                "type": "datetime"
              },
              {
                "name": "vulnerabilitySeverityLevel",
                "type": "string"
              },
              {
                "name": "azResourceId",
                "type": "string"
              },
              {
                "name": "transactionId",
                "type": "string"
              },
              {
                "name": "eventTimeStamp",
                "type": "datetime"
              },
              {
                "name": "status",
                "type": "string"
              }
            ]
          },
          "Custom-MDVMRecommendations_CL": {
            "columns": [
              {
                "name": "associatedThreats",
                "type": "dynamic"
              },
              {
                "name": "configScoreImpact",
                "type": "string"
              },
              {
                "name": "exposedMachinesCount",
                "type": "int"
              },
              {
                "name": "exposureImpact",
                "type": "real"
              },
              {
                "name": "hasUnpatchableCve",
                "type": "boolean"
              },
              {
                "name": "recId",
                "type": "string"
              },
              {
                "name": "nonProductivityImpactedAssets",
                "type": "int"
              },
              {
                "name": "productName",
                "type": "string"
              },
              {
                "name": "publicExploit",
                "type": "boolean"
              },
              {
                "name": "recommendationCategory",
                "type": "string"
              },
              {
                "name": "recommendationName",
                "type": "string"
              },
              {
                "name": "recommendedProgram",
                "type": "string"
              },
              {
                "name": "recommendedVendor",
                "type": "string"
              },
              {
                "name": "recommendedVersion",
                "type": "string"
              },
              {
                "name": "relatedComponent",
                "type": "string"
              },
              {
                "name": "remediationType",
                "type": "string"
              },
              {
                "name": "severityScore",
                "type": "int"
              },
              {
                "name": "status",
                "type": "string"
              },
              {
                "name": "subCategory",
                "type": "string"
              },
              {
                "name": "TimeGenerated",
                "type": "datetime"
              },
              {
                "name": "totalMachineCount",
                "type": "int"
              },
              {
                "name": "vendor",
                "type": "string"
              },
              {
                "name": "weaknesses",
                "type": "int"
              },
              {
                "name": "transactionId",
                "type": "string"
              },
              {
                "name": "activeAlert",
                "type": "boolean"
              }
            ]
          },
          "Custom-MDVMSecureConfigurationsByDevice_CL": {
            "columns": [
              {
                "name": "deviceId",
                "type": "string"
              },
              {
                "name": "rbacGroupId",
                "type": "int"
              },
              {
                "name": "rbacGroupName",
                "type": "string"
              },
              {
                "name": "deviceName",
                "type": "string"
              },
              {
                "name": "osPlatform",
                "type": "string"
              },
              {
                "name": "osVersion",
                "type": "string"
              },
              {
                "name": "timestamp",
                "type": "datetime"
              },
              {
                "name": "configurationId",
                "type": "string"
              },
              {
                "name": "configurationCategory",
                "type": "string"
              },
              {
                "name": "configurationSubcategory",
                "type": "string"
              },
              {
                "name": "configurationImpact",
                "type": "int"
              },
              {
                "name": "isCompliant",
                "type": "boolean"
              },
              {
                "name": "isApplicable",
                "type": "boolean"
              },
              {
                "name": "isExpectedUserImpact",
                "type": "boolean"
              },
              {
                "name": "configurationName",
                "type": "string"
              },
              {
                "name": "recommendationReference",
                "type": "string"
              },
              {
                "name": "TimeGenerated",
                "type": "datetime"
              },
              {
                "name": "transactionId",
                "type": "string"
              },
              {
                "name": "azResourceId",
                "type": "string"
              }
            ]
          },
          "Custom-MDVMCVEKB_CL": {
            "columns": [
              {
                "name": "cvssV3",
                "type": "string"
              },
              {
                "name": "description",
                "type": "string"
              },
              {
                "name": "exploitInKit",
                "type": "boolean"
              },
              {
                "name": "exploitTypes",
                "type": "dynamic"
              },
              {
                "name": "exploitUris",
                "type": "string"
              },
              {
                "name": "exploitVerified",
                "type": "boolean"
              },
              {
                "name": "cveId",
                "type": "string"
              },
              {
                "name": "name",
                "type": "string"
              },
              {
                "name": "publicExploit",
                "type": "boolean"
              },
              {
                "name": "publishedOn",
                "type": "datetime"
              },
              {
                "name": "severity",
                "type": "string"
              },
              {
                "name": "TimeGenerated",
                "type": "datetime"
              },
              {
                "name": "updatedOn",
                "type": "datetime"
              },
              {
                "name": "transactionId",
                "type": "string"
              }
            ]
          },
          "Custom-MDVMNISTCVEKB_CL": {
            "columns": [
              {
                "name": "cveId",
                "type": "string"
              },
              {
                "name": "sourceIdentifier",
                "type": "string"
              },
              {
                "name": "published",
                "type": "datetime"
              },
              {
                "name": "lastModified",
                "type": "datetime"
              },
              {
                "name": "evaluatorComment",
                "type": "string"
              },
              {
                "name": "evaluatorSolution",
                "type": "string"
              },
              {
                "name": "evaluatorImpact",
                "type": "string"
              },
              {
                "name": "vulnStatus",
                "type": "string"
              },
              {
                "name": "cisaExploitAdd",
                "type": "datetime"
              },
              {
                "name": "cisaActionDue",
                "type": "datetime"
              },
              {
                "name": "cisaRequiredAction",
                "type": "string"
              },
              {
                "name": "cisaVulnerabilityName",
                "type": "string"
              },
              {
                "name": "descriptions",
                "type": "dynamic"
              },
              {
                "name": "metrics",
                "type": "dynamic"
              },
              {
                "name": "weaknesses",
                "type": "dynamic"
              },
              {
                "name": "references",
                "type": "dynamic"
              },
              {
                "name": "vendorComments",
                "type": "dynamic"
              },
              {
                "name": "TimeGenerated",
                "type": "datetime"
              },
              {
                "name": "transactionId",
                "type": "string"
              }
            ]
          },
          "Custom-MDVMNISTConfigurations_CL": {
            "columns": [
              {
                "name": "configurationOperator",
                "type": "string"
              },
              {
                "name": "configurationNegate",
                "type": "string"
              },
              {
                "name": "nodeOperator",
                "type": "string"
              },
              {
                "name": "nodeNegate",
                "type": "boolean"
              },
              {
                "name": "criteria",
                "type": "string"
              },
              {
                "name": "matchCriteriaId",
                "type": "string"
              },
              {
                "name": "versionEndExcluding",
                "type": "string"
              },
              {
                "name": "versionEndIncluding",
                "type": "string"
              },
              {
                "name": "versionStartExcluding",
                "type": "string"
              },
              {
                "name": "versionStartIncluding",
                "type": "string"
              },
              {
                "name": "vulnerable",
                "type": "boolean"
              },
              {
                "name": "cveId",
                "type": "string"
              },
              {
                "name": "TimeGenerated",
                "type": "datetime"
              },
              {
                "name": "transactionId",
                "type": "string"
              },
              {
                "name": "configurationNumber",
                "type": "int"
              }
            ]
          }
        },
        "destinations": {
          "logAnalytics": [
            {
              "name": "[split(parameters('LogAnalyticsWorkspaceResourceId'), '/')[8]]",
              "workspaceResourceId": "[parameters('LogAnalyticsWorkspaceResourceId')]"
            }
          ]
        },
        "dataFlows": [
          {
            "streams": [
              "Custom-MDVMVulnerabilitiesByDevice_CL"
            ],
            "destinations": [
              "[split(parameters('LogAnalyticsWorkspaceResourceId'), '/')[8]]"
            ],
            "transformKql": "source",
            "outputStream": "Custom-MDVMVulnerabilitiesByDevice_CL"
          },
          {
            "streams": [
              "Custom-MDVMRecommendations_CL"
            ],
            "destinations": [
              "[split(parameters('LogAnalyticsWorkspaceResourceId'), '/')[8]]"
            ],
            "transformKql": "source",
            "outputStream": "Custom-MDVMRecommendations_CL"
          },
          {
            "streams": [
              "Custom-MDVMSecureConfigurationsByDevice_CL"
            ],
            "destinations": [
              "[split(parameters('LogAnalyticsWorkspaceResourceId'), '/')[8]]"
            ],
            "transformKql": "source",
            "outputStream": "Custom-MDVMSecureConfigurationsByDevice_CL"
          },
          {
            "streams": [
              "Custom-MDVMCVEKB_CL"
            ],
            "destinations": [
              "[split(parameters('LogAnalyticsWorkspaceResourceId'), '/')[8]]"
            ],
            "transformKql": "source",
            "outputStream": "Custom-MDVMCVEKB_CL"
          },
          {
            "streams": [
              "Custom-MDVMNISTCVEKB_CL"
            ],
            "destinations": [
              "[split(parameters('LogAnalyticsWorkspaceResourceId'), '/')[8]]"
            ],
            "transformKql": "source",
            "outputStream": "Custom-MDVMNISTCVEKB_CL"
          },
          {
            "streams": [
              "Custom-MDVMNISTConfigurations_CL"
            ],
            "destinations": [
              "[split(parameters('LogAnalyticsWorkspaceResourceId'), '/')[8]]"
            ],
            "transformKql": "source",
            "outputStream": "Custom-MDVMNISTConfigurations_CL"
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Insights/dataCollectionEndpoints', parameters('DataCollectionEndpointName'))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('LogAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('LogAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.Resources/deployments', 'tableMDVMCveKb')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('LogAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('LogAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.Resources/deployments', 'tableMDVMNistCveKb')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('LogAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('LogAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.Resources/deployments', 'tableMDVMRecommendations')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('LogAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('LogAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.Resources/deployments', 'tableMDVMSecureConfigurationsByDevice')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('LogAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('LogAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.Resources/deployments', 'tableMDVMVulnerabilitiesByDevice')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "tableMDVMCveKb",
      "subscriptionId": "[split(parameters('LogAnalyticsWorkspaceResourceId'), '/')[2]]",
      "resourceGroup": "[split(parameters('LogAnalyticsWorkspaceResourceId'), '/')[4]]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "lawName": {
            "value": "[split(parameters('LogAnalyticsWorkspaceResourceId'), '/')[8]]"
          },
          "tableName": {
            "value": "MDVMCVEKB_CL"
          },
          "plan": {
            "value": "Analytics"
          },
          "retention": {
            "value": 90
          },
          "columns": {
            "value": [
              {
                "name": "cvssV3",
                "type": "string"
              },
              {
                "name": "description",
                "type": "string"
              },
              {
                "name": "exploitInKit",
                "type": "boolean"
              },
              {
                "name": "exploitTypes",
                "type": "dynamic"
              },
              {
                "name": "exploitUris",
                "type": "string"
              },
              {
                "name": "exploitVerified",
                "type": "boolean"
              },
              {
                "name": "cveId",
                "type": "string"
              },
              {
                "name": "name",
                "type": "string"
              },
              {
                "name": "publicExploit",
                "type": "boolean"
              },
              {
                "name": "publishedOn",
                "type": "datetime"
              },
              {
                "name": "severity",
                "type": "string"
              },
              {
                "name": "TimeGenerated",
                "type": "datetime"
              },
              {
                "name": "updatedOn",
                "type": "datetime"
              },
              {
                "name": "transactionId",
                "type": "string"
              }
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.13.1.58284",
              "templateHash": "1227588407308882996"
            }
          },
          "parameters": {
            "lawName": {
              "type": "string"
            },
            "tableName": {
              "type": "string"
            },
            "plan": {
              "type": "string"
            },
            "columns": {
              "type": "array"
            },
            "retention": {
              "type": "int",
              "defaultValue": -1
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces/tables",
              "apiVersion": "2022-10-01",
              "name": "[format('{0}/{1}', parameters('lawName'), parameters('tableName'))]",
              "properties": {
                "schema": {
                  "name": "[parameters('tableName')]",
                  "columns": "[parameters('columns')]"
                },
                "plan": "[parameters('plan')]",
                "retentionInDays": "[if(not(equals(parameters('retention'), -1)), parameters('retention'), '')]"
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "tableMDVMNistCveKb",
      "subscriptionId": "[split(parameters('LogAnalyticsWorkspaceResourceId'), '/')[2]]",
      "resourceGroup": "[split(parameters('LogAnalyticsWorkspaceResourceId'), '/')[4]]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "lawName": {
            "value": "[split(parameters('LogAnalyticsWorkspaceResourceId'), '/')[8]]"
          },
          "tableName": {
            "value": "MDVMNISTCVEKB_CL"
          },
          "plan": {
            "value": "Analytics"
          },
          "retention": {
            "value": 90
          },
          "columns": {
            "value": [
              {
                "name": "cveId",
                "type": "string"
              },
              {
                "name": "sourceIdentifier",
                "type": "string"
              },
              {
                "name": "published",
                "type": "datetime"
              },
              {
                "name": "lastModified",
                "type": "datetime"
              },
              {
                "name": "evaluatorComment",
                "type": "string"
              },
              {
                "name": "evaluatorSolution",
                "type": "string"
              },
              {
                "name": "evaluatorImpact",
                "type": "string"
              },
              {
                "name": "vulnStatus",
                "type": "string"
              },
              {
                "name": "cisaExploitAdd",
                "type": "datetime"
              },
              {
                "name": "cisaActionDue",
                "type": "datetime"
              },
              {
                "name": "cisaRequiredAction",
                "type": "string"
              },
              {
                "name": "cisaVulnerabilityName",
                "type": "string"
              },
              {
                "name": "descriptions",
                "type": "dynamic"
              },
              {
                "name": "metrics",
                "type": "dynamic"
              },
              {
                "name": "weaknesses",
                "type": "dynamic"
              },
              {
                "name": "references",
                "type": "dynamic"
              },
              {
                "name": "vendorComments",
                "type": "dynamic"
              },
              {
                "name": "TimeGenerated",
                "type": "datetime"
              },
              {
                "name": "transactionId",
                "type": "string"
              }
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.13.1.58284",
              "templateHash": "1227588407308882996"
            }
          },
          "parameters": {
            "lawName": {
              "type": "string"
            },
            "tableName": {
              "type": "string"
            },
            "plan": {
              "type": "string"
            },
            "columns": {
              "type": "array"
            },
            "retention": {
              "type": "int",
              "defaultValue": -1
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces/tables",
              "apiVersion": "2022-10-01",
              "name": "[format('{0}/{1}', parameters('lawName'), parameters('tableName'))]",
              "properties": {
                "schema": {
                  "name": "[parameters('tableName')]",
                  "columns": "[parameters('columns')]"
                },
                "plan": "[parameters('plan')]",
                "retentionInDays": "[if(not(equals(parameters('retention'), -1)), parameters('retention'), '')]"
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "tableMDVMNistConfigurations",
      "subscriptionId": "[split(parameters('LogAnalyticsWorkspaceResourceId'), '/')[2]]",
      "resourceGroup": "[split(parameters('LogAnalyticsWorkspaceResourceId'), '/')[4]]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "lawName": {
            "value": "[split(parameters('LogAnalyticsWorkspaceResourceId'), '/')[8]]"
          },
          "tableName": {
            "value": "MDVMNISTConfigurations_CL"
          },
          "plan": {
            "value": "Analytics"
          },
          "retention": {
            "value": 90
          },
          "columns": {
            "value": [
              {
                "name": "configurationOperator",
                "type": "string"
              },
              {
                "name": "configurationNegate",
                "type": "string"
              },
              {
                "name": "nodeOperator",
                "type": "string"
              },
              {
                "name": "nodeNegate",
                "type": "boolean"
              },
              {
                "name": "criteria",
                "type": "string"
              },
              {
                "name": "matchCriteriaId",
                "type": "string"
              },
              {
                "name": "versionEndExcluding",
                "type": "string"
              },
              {
                "name": "versionEndIncluding",
                "type": "string"
              },
              {
                "name": "versionStartExcluding",
                "type": "string"
              },
              {
                "name": "versionStartIncluding",
                "type": "string"
              },
              {
                "name": "vulnerable",
                "type": "boolean"
              },
              {
                "name": "cveId",
                "type": "string"
              },
              {
                "name": "TimeGenerated",
                "type": "datetime"
              },
              {
                "name": "transactionId",
                "type": "string"
              },
              {
                "name": "configurationNumber",
                "type": "int"
              }
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.13.1.58284",
              "templateHash": "1227588407308882996"
            }
          },
          "parameters": {
            "lawName": {
              "type": "string"
            },
            "tableName": {
              "type": "string"
            },
            "plan": {
              "type": "string"
            },
            "columns": {
              "type": "array"
            },
            "retention": {
              "type": "int",
              "defaultValue": -1
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces/tables",
              "apiVersion": "2022-10-01",
              "name": "[format('{0}/{1}', parameters('lawName'), parameters('tableName'))]",
              "properties": {
                "schema": {
                  "name": "[parameters('tableName')]",
                  "columns": "[parameters('columns')]"
                },
                "plan": "[parameters('plan')]",
                "retentionInDays": "[if(not(equals(parameters('retention'), -1)), parameters('retention'), '')]"
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "tableMDVMRecommendations",
      "subscriptionId": "[split(parameters('LogAnalyticsWorkspaceResourceId'), '/')[2]]",
      "resourceGroup": "[split(parameters('LogAnalyticsWorkspaceResourceId'), '/')[4]]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "lawName": {
            "value": "[split(parameters('LogAnalyticsWorkspaceResourceId'), '/')[8]]"
          },
          "tableName": {
            "value": "MDVMRecommendations_CL"
          },
          "plan": {
            "value": "Analytics"
          },
          "columns": {
            "value": [
              {
                "name": "associatedThreats",
                "type": "dynamic"
              },
              {
                "name": "configScoreImpact",
                "type": "string"
              },
              {
                "name": "exposedMachinesCount",
                "type": "int"
              },
              {
                "name": "exposureImpact",
                "type": "real"
              },
              {
                "name": "hasUnpatchableCve",
                "type": "boolean"
              },
              {
                "name": "recId",
                "type": "string"
              },
              {
                "name": "nonProductivityImpactedAssets",
                "type": "int"
              },
              {
                "name": "productName",
                "type": "string"
              },
              {
                "name": "publicExploit",
                "type": "boolean"
              },
              {
                "name": "recommendationCategory",
                "type": "string"
              },
              {
                "name": "recommendationName",
                "type": "string"
              },
              {
                "name": "recommendedProgram",
                "type": "string"
              },
              {
                "name": "recommendedVendor",
                "type": "string"
              },
              {
                "name": "recommendedVersion",
                "type": "string"
              },
              {
                "name": "relatedComponent",
                "type": "string"
              },
              {
                "name": "remediationType",
                "type": "string"
              },
              {
                "name": "severityScore",
                "type": "int"
              },
              {
                "name": "status",
                "type": "string"
              },
              {
                "name": "subCategory",
                "type": "string"
              },
              {
                "name": "TimeGenerated",
                "type": "datetime"
              },
              {
                "name": "totalMachineCount",
                "type": "int"
              },
              {
                "name": "vendor",
                "type": "string"
              },
              {
                "name": "weaknesses",
                "type": "int"
              },
              {
                "name": "transactionId",
                "type": "string"
              },
              {
                "name": "activeAlert",
                "type": "boolean"
              }
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.13.1.58284",
              "templateHash": "1227588407308882996"
            }
          },
          "parameters": {
            "lawName": {
              "type": "string"
            },
            "tableName": {
              "type": "string"
            },
            "plan": {
              "type": "string"
            },
            "columns": {
              "type": "array"
            },
            "retention": {
              "type": "int",
              "defaultValue": -1
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces/tables",
              "apiVersion": "2022-10-01",
              "name": "[format('{0}/{1}', parameters('lawName'), parameters('tableName'))]",
              "properties": {
                "schema": {
                  "name": "[parameters('tableName')]",
                  "columns": "[parameters('columns')]"
                },
                "plan": "[parameters('plan')]",
                "retentionInDays": "[if(not(equals(parameters('retention'), -1)), parameters('retention'), '')]"
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "tableMDVMSecureConfigurationsByDevice",
      "subscriptionId": "[split(parameters('LogAnalyticsWorkspaceResourceId'), '/')[2]]",
      "resourceGroup": "[split(parameters('LogAnalyticsWorkspaceResourceId'), '/')[4]]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "lawName": {
            "value": "[split(parameters('LogAnalyticsWorkspaceResourceId'), '/')[8]]"
          },
          "tableName": {
            "value": "MDVMSecureConfigurationsByDevice_CL"
          },
          "plan": {
            "value": "Analytics"
          },
          "columns": {
            "value": [
              {
                "name": "deviceId",
                "type": "string"
              },
              {
                "name": "rbacGroupId",
                "type": "int"
              },
              {
                "name": "rbacGroupName",
                "type": "string"
              },
              {
                "name": "deviceName",
                "type": "string"
              },
              {
                "name": "osPlatform",
                "type": "string"
              },
              {
                "name": "osVersion",
                "type": "string"
              },
              {
                "name": "timestamp",
                "type": "datetime"
              },
              {
                "name": "configurationId",
                "type": "string"
              },
              {
                "name": "configurationCategory",
                "type": "string"
              },
              {
                "name": "configurationSubcategory",
                "type": "string"
              },
              {
                "name": "configurationImpact",
                "type": "int"
              },
              {
                "name": "isCompliant",
                "type": "boolean"
              },
              {
                "name": "isApplicable",
                "type": "boolean"
              },
              {
                "name": "isExpectedUserImpact",
                "type": "boolean"
              },
              {
                "name": "configurationName",
                "type": "string"
              },
              {
                "name": "recommendationReference",
                "type": "string"
              },
              {
                "name": "TimeGenerated",
                "type": "datetime"
              },
              {
                "name": "transactionId",
                "type": "string"
              },
              {
                "name": "azResourceId",
                "type": "string"
              }
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.13.1.58284",
              "templateHash": "1227588407308882996"
            }
          },
          "parameters": {
            "lawName": {
              "type": "string"
            },
            "tableName": {
              "type": "string"
            },
            "plan": {
              "type": "string"
            },
            "columns": {
              "type": "array"
            },
            "retention": {
              "type": "int",
              "defaultValue": -1
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces/tables",
              "apiVersion": "2022-10-01",
              "name": "[format('{0}/{1}', parameters('lawName'), parameters('tableName'))]",
              "properties": {
                "schema": {
                  "name": "[parameters('tableName')]",
                  "columns": "[parameters('columns')]"
                },
                "plan": "[parameters('plan')]",
                "retentionInDays": "[if(not(equals(parameters('retention'), -1)), parameters('retention'), '')]"
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "tableMDVMVulnerabilitiesByDevice",
      "subscriptionId": "[split(parameters('LogAnalyticsWorkspaceResourceId'), '/')[2]]",
      "resourceGroup": "[split(parameters('LogAnalyticsWorkspaceResourceId'), '/')[4]]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "lawName": {
            "value": "[split(parameters('LogAnalyticsWorkspaceResourceId'), '/')[8]]"
          },
          "tableName": {
            "value": "MDVMVulnerabilitiesByDevice_CL"
          },
          "plan": {
            "value": "Analytics"
          },
          "columns": {
            "value": [
              {
                "name": "cveId",
                "type": "string"
              },
              {
                "name": "cvssScore",
                "type": "real"
              },
              {
                "name": "deviceId",
                "type": "string"
              },
              {
                "name": "deviceName",
                "type": "string"
              },
              {
                "name": "diskPaths",
                "type": "dynamic"
              },
              {
                "name": "endOfSupportDate",
                "type": "dynamic"
              },
              {
                "name": "endOfSupportStatus",
                "type": "dynamic"
              },
              {
                "name": "exploitabilityLevel",
                "type": "string"
              },
              {
                "name": "firstSeenTimestamp",
                "type": "datetime"
              },
              {
                "name": "vulnId",
                "type": "string"
              },
              {
                "name": "lastSeenTimestamp",
                "type": "datetime"
              },
              {
                "name": "osArchitecture",
                "type": "string"
              },
              {
                "name": "osPlatform",
                "type": "string"
              },
              {
                "name": "osVersion",
                "type": "string"
              },
              {
                "name": "rbacGroupId",
                "type": "int"
              },
              {
                "name": "rbacGroupName",
                "type": "string"
              },
              {
                "name": "recommendationReference",
                "type": "string"
              },
              {
                "name": "recommendedSecurityUpdate",
                "type": "dynamic"
              },
              {
                "name": "recommendedSecurityUpdateId",
                "type": "dynamic"
              },
              {
                "name": "recommendedSecurityUpdateUrl",
                "type": "dynamic"
              },
              {
                "name": "registryPaths",
                "type": "dynamic"
              },
              {
                "name": "securityUpdateAvailable",
                "type": "boolean"
              },
              {
                "name": "softwareName",
                "type": "string"
              },
              {
                "name": "softwareVendor",
                "type": "string"
              },
              {
                "name": "softwareVersion",
                "type": "string"
              },
              {
                "name": "TimeGenerated",
                "type": "datetime"
              },
              {
                "name": "vulnerabilitySeverityLevel",
                "type": "string"
              },
              {
                "name": "azResourceId",
                "type": "string"
              },
              {
                "name": "transactionId",
                "type": "string"
              },
              {
                "name": "eventTimeStamp",
                "type": "datetime"
              },
              {
                "name": "status",
                "type": "string"
              }
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.13.1.58284",
              "templateHash": "1227588407308882996"
            }
          },
          "parameters": {
            "lawName": {
              "type": "string"
            },
            "tableName": {
              "type": "string"
            },
            "plan": {
              "type": "string"
            },
            "columns": {
              "type": "array"
            },
            "retention": {
              "type": "int",
              "defaultValue": -1
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces/tables",
              "apiVersion": "2022-10-01",
              "name": "[format('{0}/{1}', parameters('lawName'), parameters('tableName'))]",
              "properties": {
                "schema": {
                  "name": "[parameters('tableName')]",
                  "columns": "[parameters('columns')]"
                },
                "plan": "[parameters('plan')]",
                "retentionInDays": "[if(not(equals(parameters('retention'), -1)), parameters('retention'), '')]"
              }
            }
          ]
        }
      }
    }
  ],
  "outputs": {
    "DcrImmutableId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Insights/dataCollectionRules', parameters('DataCollectionRuleName')), '2022-06-01').immutableId]"
    },
    "DceUri": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Insights/dataCollectionEndpoints', parameters('DataCollectionEndpointName')), '2021-09-01-preview').logsIngestion.endpoint]"
    },
    "DcrName": {
      "type": "string",
      "value": "[parameters('DataCollectionRuleName')]"
    }
  }
}